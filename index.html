<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tetris Mini ‚Äî Neon Arcade</title>
  <style>
    :root{
      --bg1:#070b12;--bg2:#0a0f1f;--panel:#0d1224;--neon:#00e5ff;--pink:#ff3eb5;--lime:#a3ff12;--text:#e6f1ff;--muted:#94a3b8;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial; color:var(--text);
      background: radial-gradient(1200px 800px at 50% -10%, #10172a 0%, #070b12 60%, #05070c 100%);
      display:grid; place-items:center; padding:16px;
    }

    .shell{width: min(1000px, 96vw); position:relative}

    /* Start screen */
    .start{position:absolute; inset:0; display:grid; place-items:center; background:linear-gradient(180deg,rgba(0,0,0,.75),rgba(0,0,0,.85)); border:1px solid rgba(255,255,255,.06); border-radius:16px}
    .start .inner{display:grid; gap:16px; place-items:center; text-align:center; padding:32px 24px; backdrop-filter: blur(2px);}    
    .title{font-weight:900; font-size:28px; letter-spacing:.6px; color:var(--neon); text-shadow:0 0 24px rgba(0,229,255,.7)}
    .subtitle{color:var(--muted)}
    .btn{appearance:none; border:1px solid rgba(255,255,255,.12); background:var(--neon); color:#00131a; font-weight:800; padding:12px 18px; border-radius:12px; cursor:pointer; box-shadow:0 10px 30px rgba(0,229,255,.25);}
    .btn:hover{filter:brightness(1.05)}

    .layout{display:grid; grid-template-columns: minmax(280px, 420px) 240px; gap:18px}
    @media (max-width: 760px){ .layout{grid-template-columns: 1fr} }

    .card{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:12px; box-shadow: 0 20px 60px rgba(0,0,0,.35); position:relative}

    /* Board + glow border */
    #board{ display:block; width:100%; height:auto; background:#050a14; border-radius:14px; outline:none; }
    .glow{ position:absolute; inset:12px; border-radius:14px; pointer-events:none; box-shadow: 0 0 0 2px rgba(0,229,255,.35), 0 0 40px rgba(0,229,255,.18) inset; }

    /* Sidebar */
    .side{ display:grid; gap:12px; align-content:start }
    .panel{ background:#0b1020; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:12px }
    .label{font-size:12px; color:var(--muted); margin-bottom:6px}
    .value{font-size:20px; font-weight:800}
    #next{ display:block; width:100%; background:#070c18; border-radius:10px; border:1px solid rgba(255,255,255,.08) }

    /* Game Over overlay */
    .overlay{ position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px; background:radial-gradient(500px 300px at 50% 40%, rgba(255,0,80,.08), rgba(0,0,0,.92)); border-radius:16px; backdrop-filter: blur(2px); visibility:hidden }
    .overlay.visible{ visibility:visible }
    .overlay h2{ margin:0; font-size:32px; color:var(--pink); text-shadow: 0 0 18px rgba(255,62,181,.6) }
    .overlay .score{ color:var(--muted) }

    /* Mobile controls */
    .mobile{ display:none; grid-template-columns: repeat(5,1fr); gap:8px; margin-top:10px }
    .mkey{ padding:14px 10px; border-radius:12px; border:1px solid rgba(255,255,255,.08); background:#0b1020; color:var(--text); font-weight:800 }
    @media (max-width: 760px){ .mobile{ display:grid } }
  </style>
</head>
<body>
  <div class="shell">
    <div class="layout">
      <!-- Board card -->
      <div class="card" id="boardCard">
        <canvas id="board" width="300" height="600"></canvas>
        <div class="glow" aria-hidden="true"></div>
        <div id="overlay" class="overlay">
          <h2>üíÄ GAME OVER</h2>
          <div class="score">Puntaje: <span id="finalScore">0</span></div>
          <button class="btn" id="btnRestart">Reintentar</button>
        </div>

        <div class="mobile">
          <button class="mkey" data-act="left">‚üµ</button>
          <button class="mkey" data-act="rotL">‚ü≤</button>
          <button class="mkey" data-act="rotR">‚ü≥</button>
          <button class="mkey" data-act="down">‚ñº</button>
          <button class="mkey" data-act="right">‚ü∂</button>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="side">
        <div class="panel">
          <div class="label">Puntaje</div>
          <div class="value" id="score">0</div>
        </div>
        <div class="panel">
          <div class="label">Nivel</div>
          <div class="value" id="level">1</div>
        </div>
        <div class="panel">
          <div class="label">L√≠neas</div>
          <div class="value" id="lines">0</div>
        </div>
        <div class="panel">
          <div class="label">Siguiente pieza</div>
          <canvas id="next" width="120" height="120"></canvas>
        </div>
        <div class="panel">
          <div class="label">Controles</div>
          <div style="font-size:12px; color:var(--muted)">
            ‚Üê ‚Üí mover ¬∑ ‚Üì bajar (mantener) ¬∑ Barra = ca√≠da dura ¬∑ ‚Üë gira CW ¬∑ Z gira CCW ¬∑ P pausa ¬∑ R reiniciar
          </div>
        </div>
      </div>
    </div>

    <!-- Start screen on top of everything -->
    <div id="start" class="start">
      <div class="inner">
        <div class="title">Tetris Mini ‚Äî Neon Arcade</div>
        <div class="subtitle">Listo para salvar la materia üòé. ¬°Dale Start!</div>
        <button id="btnStart" class="btn">‚ñ∂ Start</button>
      </div>
    </div>
  </div>

  <!-- Funny SFX (online). Para APK, copia archivos locales y cambia los src. -->
  <audio id="sfxDrop" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>
  <audio id="sfxLine" src="https://actions.google.com/sounds/v1/cartoon/drip_echo.ogg" preload="auto"></audio>
  <audio id="sfxGameOver" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" preload="auto"></audio>
  <audio id="sfxRotate" src="https://actions.google.com/sounds/v1/cartoon/pop.ogg" preload="auto"></audio>

  <script>
    // ===== Canvas setup (draw in cell units) =====
    const COLS = 10, ROWS = 20, CELL = 30;
    const board = document.getElementById('board');
    const ctx = board.getContext('2d');
    // Ensure pixel-perfect scaling
    board.width = COLS * CELL; board.height = ROWS * CELL;
    ctx.scale(CELL, CELL);

    const nextCanvas = document.getElementById('next');
    const nctx = nextCanvas.getContext('2d');
    nextCanvas.width = 4 * CELL; nextCanvas.height = 4 * CELL;
    nctx.scale(CELL, CELL);

    // ===== UI refs =====
    const scoreEl = document.getElementById('score');
    const levelEl = document.getElementById('level');
    const linesEl = document.getElementById('lines');
    const overlay = document.getElementById('overlay');
    const finalScoreEl = document.getElementById('finalScore');
    const startScreen = document.getElementById('start');

    // ===== SFX =====
    const SFX = {
      drop: document.getElementById('sfxDrop'),
      line: document.getElementById('sfxLine'),
      over: document.getElementById('sfxGameOver'),
      rot: document.getElementById('sfxRotate'),
    };
    function sfx(name){ const a = SFX[name]; if(!a) return; try{ a.currentTime=0; a.play(); }catch(e){} }

    // ===== Tetris core =====
    function createMatrix(w,h){ return Array.from({length:h}, ()=>Array(w).fill(0)); }
    function cloneMatrix(m){ return m.map(r=>r.slice()); }

    const COLORS = [null, '#00e5ff', '#ff3eb5', '#a3ff12', '#ffd400', '#8b5cf6', '#22d3ee', '#ff8b3e'];

    function createPiece(type){
      switch(type){
        case 'T': return [[0,0,0],[1,1,1],[0,1,0]];
        case 'O': return [[2,2],[2,2]];
        case 'L': return [[0,3,0],[0,3,0],[0,3,3]];
        case 'J': return [[0,4,0],[0,4,0],[4,4,0]];
        case 'I': return [[0,5,0,0],[0,5,0,0],[0,5,0,0],[0,5,0,0]];
        case 'S': return [[0,6,6],[6,6,0]];
        case 'Z': return [[7,7,0],[0,7,7]];
      }
    }

    function rotate(matrix, dir){
      // Transpose
      for(let y=0; y<matrix.length; y++){
        for(let x=0; x<y; x++){
          [matrix[x][y], matrix[y][x]] = [matrix[y][x], matrix[x][y]];
        }
      }
      if(dir>0){ matrix.forEach(row=>row.reverse()); } else { matrix.reverse(); }
    }

    function collide(arena, player){
      const m = player.matrix; const o = player.pos;
      for(let y=0; y<m.length; y++){
        for(let x=0; x<m[y].length; x++){
          if(m[y][x]!==0 && ((arena[y+o.y] && arena[y+o.y][x+o.x])!==0)) return true;
        }
      }
      return false;
    }

    function merge(arena, player){
      player.matrix.forEach((row,y)=>{
        row.forEach((v,x)=>{ if(v!==0) arena[y+player.pos.y][x+player.pos.x] = v; });
      });
    }

    function drawCell(x,y,c){
      ctx.save();
      ctx.globalCompositeOperation = 'lighter';
      ctx.fillStyle = c; ctx.fillRect(x, y, 1, 1);
      // glow
      ctx.shadowColor = c; ctx.shadowBlur = 16; ctx.strokeStyle = c; ctx.lineWidth = 0.06; ctx.strokeRect(x+0.05,y+0.05,0.9,0.9);
      ctx.restore();
    }

    function drawMatrix(m, o, context2D=ctx){
      for(let y=0;y<m.length;y++){
        for(let x=0;x<m[y].length;x++){
          const v=m[y][x]; if(v!==0){
            const color = COLORS[v] || '#9ca3af';
            if(context2D===ctx) drawCell(x+o.x, y+o.y, color);
            else { context2D.fillStyle=color; context2D.fillRect(x+o.x, y+o.y, 1, 1); }
          }
        }
      }
    }

    function draw(){
      // background grid
      ctx.clearRect(0,0,COLS,ROWS);
      ctx.fillStyle = '#050a14'; ctx.fillRect(0,0,COLS,ROWS);
      // light grid
      ctx.strokeStyle = 'rgba(255,255,255,.05)'; ctx.lineWidth = 0.02;
      for(let x=0; x<=COLS; x++){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,ROWS); ctx.stroke(); }
      for(let y=0; y<=ROWS; y++){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(COLS,y); ctx.stroke(); }

      drawMatrix(arena, {x:0,y:0});
      drawMatrix(player.matrix, player.pos);
    }

    function drawNext(){
      nctx.clearRect(0,0,4,4); nctx.fillStyle='#070c18'; nctx.fillRect(0,0,4,4);
      if(player.next){
        // center next in 4x4 box
        const w = player.next[0].length; const h = player.next.length;
        const ox = Math.floor((4 - w)/2); const oy = Math.floor((4 - h)/2);
        drawMatrix(player.next, {x:ox, y:oy}, nctx);
      }
    }

    function arenaSweep(){
      let cleared = 0;
      outer: for(let y=arena.length-1; y>=0; y--){
        for(let x=0; x<arena[y].length; x++){
          if(arena[y][x]===0) continue outer;
        }
        const row=arena.splice(y,1)[0].fill(0);
        arena.unshift(row); y++; cleared++;
      }
      if(cleared){
        sfx('line');
        lines += cleared; score += [0,100,300,500,800][cleared] * level; // approx classic
        if(lines >= level*10){ level++; baseDrop = Math.max(120, baseDrop-70); }
        updateHUD();
      }
    }

    function playerReset(){
      if(!bag.length) refillBag();
      const type = bag.pop();
      if(player.next){ player.matrix = player.next; }
      else { player.matrix = createPiece(type); }
      // set next
      if(!bag.length) refillBag();
      player.next = createPiece(bag.pop());

      player.pos.y = 0; player.pos.x = (COLS/2|0) - (player.matrix[0].length/2|0);
      if(collide(arena, player)){
        gameOver();
      }
      drawNext();
    }

    function playerDrop(){
      player.pos.y++;
      if(collide(arena, player)){
        player.pos.y--; merge(arena, player); sfx('drop');
        arenaSweep(); playerReset();
      }
      dropCounter = 0; fastCounter = 0;
    }

    function hardDrop(){
      do { player.pos.y++; } while(!collide(arena, player));
      player.pos.y--; merge(arena, player); sfx('drop');
      arenaSweep(); playerReset();
      dropCounter = 0; fastCounter = 0;
    }

    function playerMove(dx){ player.pos.x += dx; if(collide(arena,player)) player.pos.x -= dx; }

    function playerRotate(dir){
      const posX = player.pos.x; let offset = 1;
      rotate(player.matrix, dir); sfx('rot');
      while(collide(arena, player)){
        player.pos.x += offset; offset = -(offset + (offset>0 ? 1 : -1));
        if(offset > player.matrix[0].length){ rotate(player.matrix, -dir); player.pos.x = posX; return; }
      }
    }

    function updateHUD(){ scoreEl.textContent = score; levelEl.textContent = level; linesEl.textContent = lines; }

    function gameOver(){
      running = false; overlay.classList.add('visible'); finalScoreEl.textContent = score; sfx('over');
    }

    function resetAll(){
      arena = createMatrix(COLS, ROWS);
      score = 0; lines = 0; level = 1; baseDrop = 800; fastDrop = false; dropCounter=0; fastCounter=0; bag.length=0; player.next=null;
      playerReset(); updateHUD(); draw(); overlay.classList.remove('visible');
    }

    // ===== State =====
    let arena = createMatrix(COLS, ROWS);
    let player = { pos:{x:0,y:0}, matrix:null, next:null };
    let score=0, lines=0, level=1;
    let baseDrop = 800; // ms (speed increases with level)
    let fastDrop = false; // when holding ‚Üì or touch down
    let dropCounter = 0; // accum normal
    let fastCounter = 0; // accum fast
    const FAST_INTERVAL = 55; // ms while holding
    let last = 0; let rafId = null; let running = false; let paused = false;

    // 7-bag randomizer for better distribution
    const TYPES = ['T','O','L','J','I','S','Z'];
    const bag = [];
    function refillBag(){ const tmp = TYPES.slice(); while(tmp.length){ const i = (Math.random()*tmp.length)|0; bag.push(tmp.splice(i,1)[0]); } }

    function update(ts=0){
      if(!running || paused) return;
      const dt = ts - last; last = ts;
      let interval = fastDrop ? FAST_INTERVAL : baseDrop;
      dropCounter += dt; if(fastDrop) fastCounter += dt; else fastCounter = 0;
      if(dropCounter >= interval){ playerDrop(); }
      draw();
      rafId = requestAnimationFrame(update);
    }

    // ===== Controls =====
    document.addEventListener('keydown', (e)=>{
      const k = e.key.toLowerCase();
      if(k==='arrowleft'){ playerMove(-1); }
      else if(k==='arrowright'){ playerMove(1); }
      else if(k==='arrowup'){ playerRotate(1); }
      else if(k==='z'){ playerRotate(-1); }
      else if(k===' '){ e.preventDefault(); hardDrop(); }
      else if(k==='arrowdown'){ fastDrop = true; }
      else if(k==='p'){ paused = !paused; if(!paused) { last=performance.now(); rafId=requestAnimationFrame(update);} }
      else if(k==='r'){ resetAll(); startGameLoop(); }
      draw();
    });
    document.addEventListener('keyup', (e)=>{ if(e.key==='ArrowDown') fastDrop=false; });

    // Mobile buttons
    document.querySelectorAll('.mkey').forEach(btn=>{
      const act = btn.dataset.act;
      if(act==='down'){
        const press = ()=>{ fastDrop=true; };
        const release = ()=>{ fastDrop=false; };
        btn.addEventListener('pointerdown', press);
        btn.addEventListener('pointerup', release);
        btn.addEventListener('pointerleave', release);
        btn.addEventListener('pointercancel', release);
        return;
      }
      btn.addEventListener('click', ()=>{
        if(act==='left') playerMove(-1);
        if(act==='right') playerMove(1);
        if(act==='rotL') playerRotate(-1);
        if(act==='rotR') playerRotate(1);
        draw();
      });
    });

    // ===== Start / Restart =====
    document.getElementById('btnStart').addEventListener('click', ()=>{ resetAll(); startScreen.style.display='none'; startGameLoop(); });
    document.getElementById('btnRestart').addEventListener('click', ()=>{ resetAll(); startGameLoop(); });

    function startGameLoop(){ running = true; paused = false; last = performance.now(); if(rafId) cancelAnimationFrame(rafId); rafId = requestAnimationFrame(update); }

    // Initial draw (board empty under start screen)
    draw(); drawNext();
  </script>
</body>
</html>
